
sudo apt update && sudo apt install sudo curl unzip -y

curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

sudo useradd --no-create-home prometheus
sudo useradd --no-create-home Node_exporter
 
sudo mkdir /etc/prometheus
sudo mkdir /var/lib/prometheus

wget https://github.com/prometheus/prometheus/releases/download/v2.36.0/prometheus-2.36.0.linux-amd64.tar.gz
tar xvfz prometheus-2.36.0.linux-amd64.tar.gz

sudo cp prometheus-2.36.0.linux-amd64/prometheus /usr/local/bin
sudo cp prometheus-2.36.0.linux-amd64/promtool /usr/local/bin/
sudo cp -r prometheus-2.36.0.linux-amd64/consoles /etc/prometheus
sudo cp -r prometheus-2.36.0.linux-amd64/console_libraries /etc/prometheus
rm -rf prometheus-2.36.0.linux-amd64.tar.gz prometheus-2.36.0.linux-amd64

wget https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz
tar xzf node_exporter-1.3.1.linux-amd64.tar.gz
sudo cp node_exporter-1.3.1.linux-amd64/node_exporter /usr/local/bin/node_exporter
rm -rf node_exporter-1.3.1.linux-amd64.tar.gz node_exporter-1.3.1.linux-amd64

sudo nano /etc/prometheus/prometheus.yml

global:
  scrape_interval: 15s
  external_labels:
    monitor: 'prometheus'

scrape_configs:
  - job_name: 'prometheus'
    ec2_sd_configs:
      - region: us-east-1
        port: 9100
        filters:
           - name: tag:Project
             values: [Udapeople]
	relabel_configs:
       - source_labels: [__meta_ec2_tag_Project, __meta_ec2_tag_Name]
         separator:"_"
         target_label: instance
       - source_labels:[__meta_ec2_instance_id]
         target_label: instance_id
       - source_labels: [__meta_ec2_public_dns_name]
         target_label: public_dns_name	   
--

- source_labels: [host, port]
  separator: "_"
  target_label: "address"
		
sudo nano /etc/systemd/system/prometheus.service

[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
    --config.file /etc/prometheus/prometheus.yml \
    --storage.tsdb.path /var/lib/prometheus/ \
    --web.console.templates=/etc/prometheus/consoles \
    --web.console.libraries=/etc/prometheus/console_libraries

[Install]
WantedBy=multi-user.target

sudo nano /etc/systemd/system/node-exporter.service

[Unit]
Description=Prometheus Node Exporter Service
After=network.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target


sudo chown prometheus:prometheus /etc/prometheus
sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/promtool
sudo chown -R prometheus:prometheus /etc/prometheus/consoles
sudo chown -R prometheus:prometheus /etc/prometheus/console_libraries
sudo chown -R prometheus:prometheus /var/lib/prometheus

sudo systemctl daemon-reload
sudo systemctl enable prometheus
sudo systemctl enable node-exporter
sudo systemctl start node-exporter
sudo systemctl start prometheus
sudo systemctl status node-exporter
sudo systemctl status prometheus

sudo systemctl restart node-exporter
sudo systemctl restart prometheus

rm -rf /etc/systemd/system/node-exporter.service
rm -rf /etc/systemd/system/prometheus.service
rm -rf /etc/prometheus/prometheus.yml

For CPU 
avg(rate(node_cpu_seconds_total{mode!="idle"}[1m])) by(instance) * 100
 
For Memory free
 node_memory_Cached_bytes + node_memory_Buffers_bytes + node_memory_MemFree_bytes
 
 